<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex, nofollow" />
<meta name="description" content="Zynvrae 客服中心即時聊天室系統。" />
<title>Zynvrae 客服中心聊天室</title>

<style>
  :root{
    --bg:#f2f2f2;
    --card:#fff;
    --border:#e6e6e6;
    --text:#111;
    --muted:#6b6b6b;

    --lineGreen:#06c755;
    --lineGreenDark:#05b44c;

    --chatBg:#e5ddd5;
    --bubbleMe:#d9fdd3;
    --bubbleOther:#ffffff;

    --danger:#ff3b30;
    --shadow:0 10px 30px rgba(0,0,0,0.10);
    --radius:16px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: Arial, system-ui, -apple-system, "Noto Sans TC", sans-serif;
    background:var(--bg);
    color:var(--text);
    display:flex;
    justify-content:center;
    padding:18px;
  }
  #app{ width:min(1080px, 100%); }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .hidden{ display:none !important; }

  button{
    border:none;
    cursor:pointer;
    border-radius:999px;
    padding:10px 14px;
    font-weight:700;
  }
  .btnPrimary{ background:var(--lineGreen); color:#fff; }
  .btnPrimary:hover{ background:var(--lineGreenDark); }
  .btnDark{ background:#222; color:#fff; }
  .btnGhost{
    background:rgba(255,255,255,0.18);
    color:#fff;
    border:1px solid rgba(255,255,255,0.25);
  }

  input{
    width:100%;
    border:1px solid #dcdcdc;
    border-radius:12px;
    padding:12px 12px;
    outline:none;
    font-size:14px;
  }
  input:focus{ border-color:#b8b8b8; }

  .small{ font-size:12px; color:var(--muted); line-height:1.45; }

  .centerWrap{ padding:18px; }
  .title{
    font-size:22px;
    font-weight:900;
    margin:0 0 12px;
  }
  .roleBtns{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:10px;
  }
  .roleBtnBig{
    padding:18px 14px;
    border-radius:16px;
    font-size:16px;
    font-weight:900;
  }
  .actions{
    display:flex;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  .shell{
    height:min(84vh, 820px);
    display:grid;
    grid-template-columns: 360px 1fr;
    border-radius:var(--radius);
    overflow:hidden;
  }

  .side{
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .sideTop{
    background:var(--lineGreen);
    color:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sideTopTitle{
    font-weight:900;
    letter-spacing:0.2px;
  }
  .sideSearch{
    padding:10px;
    border-bottom:1px solid var(--border);
    background:#fff;
  }
  .sideSearch input{
    border-radius:999px;
    padding:10px 12px;
  }
  .chatList{
    overflow-y:auto;
    min-height:0;
    background:#fff;
  }
  .chatItem{
    display:grid;
    grid-template-columns: 44px 1fr auto;
    gap:10px;
    padding:10px 12px;
    border-bottom:1px solid #f2f2f2;
    cursor:pointer;
    align-items:center;
  }
  .chatItem:hover{ background:#fafafa; }
  .chatItem.active{ background:#eefbf3; }

  .avatar{
    width:44px;height:44px;border-radius:50%;
    background:#e9e9e9;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;color:#333;
  }

  .chatMain{ min-width:0; }
  .chatName{
    font-weight:900;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .chatPreview{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    margin-top:2px;
  }

  .chatMeta{
    text-align:right;
    font-size:11px;
    color:var(--muted);
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:6px;
  }

  .badgeUnread{
    background:var(--danger);
    color:#fff;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    display:none;
  }
  .badgeUnread.show{ display:inline-block; }

  .main{
    display:flex;
    flex-direction:column;
    min-height:0;
    background:#fff;
  }
  .mainTop{
    padding:10px 14px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    background:#fff;
  }
  .mainTitle{
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width:0;
  }
  .mainTitle .room{
    font-weight:900;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .mainTitle .sub{
    font-size:12px;
    color:var(--muted);
  }
  .mainActions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .chip{
    background:#f3f3f3;
    border:1px solid #e6e6e6;
    padding:8px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:12px;
  }

  .thread{
    flex:1;
    min-height:0;
    overflow-y:auto;
    padding:14px;
    background:var(--chatBg);
  }

  .row{
    display:flex;
    margin:8px 0;
  }
  .row.me{ justify-content:flex-end; }
  .row.other{ justify-content:flex-start; }

  .bubble{
    max-width:min(560px, 88%);
    padding:10px 12px;
    border-radius:14px;
    box-shadow:0 1px 0 rgba(0,0,0,0.06);
    word-break:break-word;
  }
  .bubble.me{
    background:var(--bubbleMe);
    border-top-right-radius:6px;
  }
  .bubble.other{
    background:var(--bubbleOther);
    border-top-left-radius:6px;
  }
  .bMeta{
    margin-top:6px;
    font-size:11px;
    color:rgba(0,0,0,0.55);
    display:flex;
    gap:10px;
    justify-content:flex-end;
  }
  .row.other .bMeta{ justify-content:flex-start; }

  .composer{
    border-top:1px solid var(--border);
    padding:10px;
    background:#fff;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .iconBtn{
    width:40px;height:40px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:#f3f3f3;border:1px solid #e6e6e6;
    cursor:pointer;
    flex:0 0 auto;
  }
  .composer input{
    margin:0;
    border-radius:999px;
    padding:12px 14px;
  }
  .sendBtn{
    background:var(--lineGreen);
    color:#fff;
    border-radius:999px;
    padding:12px 16px;
    font-weight:900;
  }
  .sendBtn:hover{ background:var(--lineGreenDark); }

  @media (max-width: 860px){
    .shell{ grid-template-columns: 1fr; }
    .side{ display:none; }
    .roleBtns{ grid-template-columns: 1fr; }
  }
</style>
</head>

<body>
<div id="app">

  <div id="roleCard" class="card">
    <div class="centerWrap">
      <div class="title">客服中心</div>
      <div class="roleBtns">
        <button class="btnPrimary roleBtnBig" id="goCustomerBtn">我是客戶</button>
        <button class="btnDark roleBtnBig" id="goAdminBtn">我是管理員</button>
      </div>
    </div>
  </div>

  <!-- 客戶端登入畫面已移除：用 prompt -->

  <div id="adminLoginCard" class="card hidden">
    <div class="centerWrap">
      <div class="title">管理員</div>

      <div>
        <div class="small">管理員密碼</div>
        <input id="adminPassInput" type="password" placeholder="輸入密碼" />
      </div>

      <div class="actions">
        <button class="btnDark" id="adminEnterBtn">進入後台</button>
        <button class="btnPrimary" id="backToRoleFromAdmin">返回</button>
      </div>
    </div>
  </div>

  <div id="customerShell" class="card hidden">
    <div class="shell">
      <div class="side">
        <div class="sideTop">
          <div class="sideTopTitle">客服中心</div>
          <button class="btnGhost" id="customerExitBtn">離開</button>
        </div>
        <div class="sideSearch">
          <input id="customerSearch" placeholder="搜尋" disabled />
        </div>
        <div class="chatList" id="customerChatList"></div>
      </div>

      <div class="main">
        <div class="mainTop">
          <div class="mainTitle">
            <div class="room" id="customerRoomTitle">房間：-</div>
            <div class="sub" id="customerRoomSub">-</div>
          </div>
          <div class="mainActions">
            <button class="chip" id="customerMarkReadBtn">標記已讀</button>
            <button class="chip" id="customerChangeRoomBtn">換房間碼</button>
          </div>
        </div>

        <div class="thread" id="customerThread"></div>

        <form class="composer" id="customerForm">
          <div class="iconBtn" title="表情（示意）">😊</div>
          <input id="customerInput" placeholder="輸入訊息…" autocomplete="off" />
          <button class="sendBtn" type="submit">送出</button>
        </form>
      </div>
    </div>
  </div>

  <div id="adminShell" class="card hidden">
    <div class="shell">
      <div class="side">
        <div class="sideTop">
          <div class="sideTopTitle">客服後台</div>
          <button class="btnGhost" id="adminExitBtn">離開</button>
        </div>

        <div class="sideSearch">
          <input id="adminSearch" placeholder="搜尋房間碼…" />
        </div>

        <div class="chatList" id="adminChatList"></div>
      </div>

      <div class="main">
        <div class="mainTop">
          <div class="mainTitle">
            <div class="room" id="adminRoomTitle">尚未選擇房間</div>
            <div class="sub" id="adminRoomSub">點左側對話開始回覆</div>
          </div>
          <div class="mainActions">
            <button class="chip" id="adminNewRoomBtn">手動輸入房間</button>
            <button class="chip" id="adminMarkReadBtn">標記已讀</button>
            <button class="chip" id="adminCopyRoomBtn">複製房間碼</button>
            <button class="chip" id="adminDeleteRoomBtn">刪除對話</button>
          </div>
        </div>

        <div class="thread" id="adminThread"></div>

        <form class="composer" id="adminForm">
          <div class="iconBtn" title="快捷（示意）">⚡</div>
          <input id="adminInput" placeholder="請先選擇房間…" autocomplete="off" disabled />
          <button class="sendBtn" type="submit">送出</button>
        </form>
      </div>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  where,
  orderBy,
  limit,
  getDocs,
  writeBatch,
  startAfter
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* =======================
   Firebase Config
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyD9bdDtq3BWDtq3BWDt9P_e4Uw8DftbThDNT1RsE",
  authDomain: "talk-2114b.firebaseapp.com",
  projectId: "talk-2114b",
  storageBucket: "talk-2114b.firebasestorage.app",
  messagingSenderId: "374632969029",
  appId: "1:374632969029:web:3d10fb1077796a237c842c",
  measurementId: "G-FBVL3RY2GJ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
   Utilities
======================= */
function sanitizeRoom(r){
  return (r || "").trim().replace(/\s+/g, "").slice(0, 32);
}
function sanitizeName(n){
  return (n || "").trim().slice(0, 20);
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function fmtTime(ts){
  const d = new Date(ts || Date.now());
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function initials(s){
  const t = (s||"").trim();
  return t ? t.slice(0,2).toUpperCase() : "客";
}
function setHidden(el, hidden){
  if(hidden) el.classList.add("hidden");
  else el.classList.remove("hidden");
}
function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){
    return fallback;
  }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* =======================
   Global State
======================= */
let mode = "none"; // none | customer | admin

let customerRoom = "";
let customerName = "";
let customerUnsubRoom = null;
let customerLastSeen = loadJSON("customerLastSeenByRoom", {}); // {room: ts}

let adminSelectedRoom = "";
let adminUnsubRoom = null;
let adminUnsubRecent = null;
let adminRoomsMap = new Map();
let adminLastSeen = loadJSON("adminLastSeenByRoom", {}); // {room: ts}

/* =======================
   DOM
======================= */
const roleCard = document.getElementById("roleCard");
const adminLoginCard = document.getElementById("adminLoginCard");

const goCustomerBtn = document.getElementById("goCustomerBtn");
const goAdminBtn = document.getElementById("goAdminBtn");

const adminPassInput = document.getElementById("adminPassInput");
const adminEnterBtn = document.getElementById("adminEnterBtn");
const backToRoleFromAdmin = document.getElementById("backToRoleFromAdmin");

// customer shell
const customerShell = document.getElementById("customerShell");
const customerExitBtn = document.getElementById("customerExitBtn");
const customerChatList = document.getElementById("customerChatList");
const customerRoomTitle = document.getElementById("customerRoomTitle");
const customerRoomSub = document.getElementById("customerRoomSub");
const customerThread = document.getElementById("customerThread");
const customerForm = document.getElementById("customerForm");
const customerInput = document.getElementById("customerInput");
const customerMarkReadBtn = document.getElementById("customerMarkReadBtn");
const customerChangeRoomBtn = document.getElementById("customerChangeRoomBtn");

// admin shell
const adminShell = document.getElementById("adminShell");
const adminExitBtn = document.getElementById("adminExitBtn");
const adminSearch = document.getElementById("adminSearch");
const adminChatList = document.getElementById("adminChatList");
const adminRoomTitle = document.getElementById("adminRoomTitle");
const adminRoomSub = document.getElementById("adminRoomSub");
const adminThread = document.getElementById("adminThread");
const adminForm = document.getElementById("adminForm");
const adminInput = document.getElementById("adminInput");
const adminNewRoomBtn = document.getElementById("adminNewRoomBtn");
const adminMarkReadBtn = document.getElementById("adminMarkReadBtn");
const adminCopyRoomBtn = document.getElementById("adminCopyRoomBtn");
const adminDeleteRoomBtn = document.getElementById("adminDeleteRoomBtn");

/* =======================
   Navigation
======================= */
function showRole(){
  mode="none";
  setHidden(roleCard, false);
  setHidden(adminLoginCard, true);
  setHidden(customerShell, true);
  setHidden(adminShell, true);
}
function showAdminLogin(){
  mode="none";
  setHidden(roleCard, true);
  setHidden(adminLoginCard, false);
  setHidden(customerShell, true);
  setHidden(adminShell, true);
}
function showCustomer(){
  mode="customer";
  setHidden(roleCard, true);
  setHidden(adminLoginCard, true);
  setHidden(customerShell, false);
  setHidden(adminShell, true);
}
function showAdmin(){
  mode="admin";
  setHidden(roleCard, true);
  setHidden(adminLoginCard, true);
  setHidden(customerShell, true);
  setHidden(adminShell, false);
}
function leaveAll(){
  if(customerUnsubRoom){ customerUnsubRoom(); customerUnsubRoom=null; }
  if(adminUnsubRoom){ adminUnsubRoom(); adminUnsubRoom=null; }
  if(adminUnsubRecent){ adminUnsubRecent(); adminUnsubRecent=null; }

  customerThread.innerHTML = "";
  customerChatList.innerHTML = "";
  adminThread.innerHTML = "";
  adminChatList.innerHTML = "";

  adminSelectedRoom = "";
  customerRoom = "";
  customerName = "";

  showRole();
}

/* =======================
   Home actions
======================= */
goCustomerBtn.onclick = () => {
  const last = loadJSON("lastCustomerProfile", {room:"", name:""});
  const r = sanitizeRoom(prompt("輸入房間碼", last.room || "") || "");
  if(!r) return;

  const n = sanitizeName(prompt("輸入暱稱", last.name || "") || "");
  if(!n) return;

  customerRoom = r;
  customerName = n;

  saveJSON("lastCustomerProfile", {room:r, name:n});

  showCustomer();
  customerSubscribeRoom();
  setTimeout(()=> customerInput?.focus(), 50);
};

goAdminBtn.onclick = () => {
  adminPassInput.value = "";
  showAdminLogin();
  adminPassInput.focus();
};

backToRoleFromAdmin.onclick = () => showRole();

/* =======================
   Customer LINE Mode
======================= */
function customerRenderChatListItem(lastText, lastTs){
  customerChatList.innerHTML = "";
  const div = document.createElement("div");
  div.className = "chatItem active";

  const seenTs = customerLastSeen[customerRoom] || 0;
  const unread = (lastTs||0) > seenTs ? 1 : 0;

  div.innerHTML = `
    <div class="avatar">${escapeHtml(initials(customerRoom))}</div>
    <div class="chatMain">
      <div class="chatName">${escapeHtml(customerRoom)}</div>
      <div class="chatPreview">${escapeHtml(lastText || "開始對話")}</div>
    </div>
    <div class="chatMeta">
      <div>${lastTs ? fmtTime(lastTs) : ""}</div>
      <div class="badgeUnread ${unread ? "show" : ""}">${unread ? "新" : ""}</div>
    </div>
  `;
  div.onclick = () => {
    if(lastTs){
      customerLastSeen[customerRoom] = lastTs;
      saveJSON("customerLastSeenByRoom", customerLastSeen);
      customerRenderChatListItem(lastText, lastTs);
    }
    customerThread.scrollTop = customerThread.scrollHeight;
  };
  customerChatList.appendChild(div);
}

function customerRenderThread(snap){
  customerThread.innerHTML = "";

  let lastText = "";
  let lastTs = 0;

  snap.forEach(d=>{
    const m = d.data();
    lastText = m.text || lastText;
    lastTs = m.timestamp || lastTs;

    const isMe = (m.role === "user" && m.sender === customerName);

    const row = document.createElement("div");
    row.className = "row " + (isMe ? "me" : "other");

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (isMe ? "me" : "other");
    bubble.innerHTML = `
      <div>${escapeHtml(m.text)}</div>
      <div class="bMeta">
        <span>${escapeHtml(m.role === "admin" ? "👑 管理員" : "🙂 客戶")}</span>
        <span>${escapeHtml(m.sender || "")}</span>
        <span>${fmtTime(m.timestamp)}</span>
      </div>
    `;
    row.appendChild(bubble);
    customerThread.appendChild(row);
  });

  customerRoomTitle.textContent = `房間：${customerRoom}`;
  customerRoomSub.textContent = `暱稱：${customerName}`;

  customerThread.scrollTop = customerThread.scrollHeight;
  customerRenderChatListItem(lastText, lastTs);
}

function customerSubscribeRoom(){
  if(customerUnsubRoom){ customerUnsubRoom(); customerUnsubRoom=null; }

  const q = query(
    collection(db,"messages"),
    where("room","==", customerRoom),
    orderBy("timestamp","asc"),
    limit(500)
  );

  customerUnsubRoom = onSnapshot(q, (snap)=>{
    customerRenderThread(snap);
  }, (err)=>{
    console.error(err);
    alert("客戶端：讀取訊息失敗\n" + (err?.message || err));
  });
}

customerExitBtn.onclick = () => leaveAll();

customerMarkReadBtn.onclick = () => {
  customerLastSeen[customerRoom] = Date.now();
  saveJSON("customerLastSeenByRoom", customerLastSeen);
  customerRenderChatListItem("（已讀）", customerLastSeen[customerRoom]);
};

customerChangeRoomBtn.onclick = () => {
  const r = sanitizeRoom(prompt("輸入新的房間碼") || "");
  if(!r) return;
  customerRoom = r;
  customerThread.innerHTML = "";
  customerChatList.innerHTML = "";
  saveJSON("lastCustomerProfile", {room:r, name:customerName});
  customerSubscribeRoom();
};

customerForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(mode !== "customer") return;
  const text = customerInput.value.trim();
  if(!text) return;

  try{
    await addDoc(collection(db,"messages"),{
      room: customerRoom,
      role: "user",
      sender: customerName,
      text,
      timestamp: Date.now()
    });
    customerInput.value = "";
  }catch(err){
    console.error(err);
    alert("客戶端：送出失敗\n" + (err?.message || err));
  }
});

/* =======================
   Admin LINE Mode
======================= */
function adminComputeUnread(room, lastTs){
  const seen = adminLastSeen[room] || 0;
  return (lastTs||0) > seen ? 1 : 0;
}

function adminRenderRoomList(){
  const kw = (adminSearch.value || "").trim().toLowerCase();
  const items = Array.from(adminRoomsMap.values())
    .filter(x => !kw || x.room.toLowerCase().includes(kw))
    .sort((a,b)=> (b.lastTs||0) - (a.lastTs||0));

  adminChatList.innerHTML = "";

  for(const it of items){
    const unread = adminComputeUnread(it.room, it.lastTs);

    const div = document.createElement("div");
    div.className = "chatItem" + (it.room === adminSelectedRoom ? " active" : "");

    div.innerHTML = `
      <div class="avatar">${escapeHtml(initials(it.room))}</div>
      <div class="chatMain">
        <div class="chatName">${escapeHtml(it.room)}</div>
        <div class="chatPreview">${escapeHtml((it.lastRole==="admin"?"👑 ":"🙂 ")+(it.lastSender?it.lastSender+"：":"")+(it.lastText||""))}</div>
      </div>
      <div class="chatMeta">
        <div>${it.lastTs ? fmtTime(it.lastTs) : ""}</div>
        <div class="badgeUnread ${unread ? "show" : ""}">${unread ? "新" : ""}</div>
      </div>
    `;

    div.onclick = () => adminSelectRoom(it.room);
    adminChatList.appendChild(div);
  }
}

function adminSelectRoom(r){
  adminSelectedRoom = r;

  adminRoomTitle.textContent = `房間：${r}`;
  adminRoomSub.textContent = "右側為此房間對話";
  adminInput.disabled = false;
  adminInput.placeholder = "輸入訊息（回覆此房間）";

  const info = adminRoomsMap.get(r);
  if(info?.lastTs){
    adminLastSeen[r] = info.lastTs;
    saveJSON("adminLastSeenByRoom", adminLastSeen);
  }

  adminRenderRoomList();
  adminSubscribeRoom();

  setTimeout(()=> adminInput?.focus(), 50);
}

function adminRenderThread(snap){
  adminThread.innerHTML = "";

  let lastTs = 0;

  snap.forEach(d=>{
    const m = d.data();
    lastTs = m.timestamp || lastTs;

    const isMe = (m.role === "admin");

    const row = document.createElement("div");
    row.className = "row " + (isMe ? "me" : "other");

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (isMe ? "me" : "other");
    bubble.innerHTML = `
      <div>${escapeHtml(m.text)}</div>
      <div class="bMeta">
        <span>${escapeHtml(m.role === "admin" ? "👑 管理員" : "🙂 客戶")}</span>
        <span>${escapeHtml(m.sender || "")}</span>
        <span>${fmtTime(m.timestamp)}</span>
      </div>
    `;
    row.appendChild(bubble);
    adminThread.appendChild(row);
  });

  adminThread.scrollTop = adminThread.scrollHeight;

  if(adminSelectedRoom && lastTs){
    adminLastSeen[adminSelectedRoom] = lastTs;
    saveJSON("adminLastSeenByRoom", adminLastSeen);
    adminRenderRoomList();
  }
}

function adminSubscribeRoom(){
  if(adminUnsubRoom){ adminUnsubRoom(); adminUnsubRoom=null; }
  if(!adminSelectedRoom) return;

  const q = query(
    collection(db,"messages"),
    where("room","==", adminSelectedRoom),
    orderBy("timestamp","asc"),
    limit(500)
  );

  adminUnsubRoom = onSnapshot(q, (snap)=>{
    adminRenderThread(snap);
  }, (err)=>{
    console.error(err);
    alert("管理員端：讀取房間訊息失敗\n" + (err?.message || err));
  });
}

function adminSubscribeRecentRooms(){
  if(adminUnsubRecent){ adminUnsubRecent(); adminUnsubRecent=null; }

  const q = query(
    collection(db,"messages"),
    orderBy("timestamp","desc"),
    limit(800)
  );

  adminUnsubRecent = onSnapshot(q, (snap)=>{
    const next = new Map();

    snap.forEach(d=>{
      const m = d.data();
      if(!m?.room) return;
      const r = m.room;

      if(!next.has(r)){
        next.set(r, {
          room: r,
          lastText: m.text || "",
          lastTs: m.timestamp || 0,
          lastSender: m.sender || "",
          lastRole: m.role || ""
        });
      }
    });

    adminRoomsMap = next;
    adminRenderRoomList();
  }, (err)=>{
    console.error(err);
    alert("管理員端：讀取對話列表失敗\n" + (err?.message || err));
  });
}

function enterAdmin(){
  const pass = (adminPassInput.value || "").trim();
  if(pass !== "990323") return alert("密碼錯誤");

  adminSelectedRoom = "";
  adminThread.innerHTML = "";
  adminRoomTitle.textContent = "尚未選擇房間";
  adminRoomSub.textContent = "點左側對話開始回覆";
  adminInput.disabled = true;
  adminInput.value = "";
  adminInput.placeholder = "請先選擇房間…";

  showAdmin();
  adminSubscribeRecentRooms();
}

adminEnterBtn.onclick = () => enterAdmin();
adminPassInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") enterAdmin(); });

adminExitBtn.onclick = () => leaveAll();
adminSearch.addEventListener("input", () => adminRenderRoomList());

adminNewRoomBtn.onclick = () => {
  const r = sanitizeRoom(prompt("輸入房間碼（你要打開的客戶房間）") || "");
  if(!r) return;
  if(!adminRoomsMap.has(r)){
    adminRoomsMap.set(r, { room:r, lastText:"（手動開啟）", lastTs:0, lastSender:"", lastRole:"" });
    adminRenderRoomList();
  }
  adminSelectRoom(r);
};

adminMarkReadBtn.onclick = () => {
  if(!adminSelectedRoom) return;
  const info = adminRoomsMap.get(adminSelectedRoom);
  const ts = info?.lastTs || Date.now();
  adminLastSeen[adminSelectedRoom] = ts;
  saveJSON("adminLastSeenByRoom", adminLastSeen);
  adminRenderRoomList();
};

adminCopyRoomBtn.onclick = async () => {
  if(!adminSelectedRoom) return alert("請先選擇房間");
  try{
    await navigator.clipboard.writeText(adminSelectedRoom);
    alert("已複製房間碼：" + adminSelectedRoom);
  }catch(e){
    alert("複製失敗（瀏覽器限制），房間碼：" + adminSelectedRoom);
  }
};

// ===== 刪除整個房間（聊天室） =====
async function deleteRoomAllMessages(room){
  // 每批最多 450（batch 上限 500）
  const BATCH_SIZE = 450;
  let total = 0;
  let lastDocSnap = null;

  while(true){
    const baseQ = query(
      collection(db, "messages"),
      where("room", "==", room),
      orderBy("timestamp", "asc"),
      limit(BATCH_SIZE)
    );

    const pageQ = lastDocSnap ? query(baseQ, startAfter(lastDocSnap)) : baseQ;
    const snap = await getDocs(pageQ);

    if(snap.empty) break;

    const batch = writeBatch(db);
    snap.docs.forEach(ds => batch.delete(ds.ref));
    await batch.commit();

    total += snap.size;
    lastDocSnap = snap.docs[snap.docs.length - 1];

    if(snap.size < BATCH_SIZE) break;
  }

  return total;
}

adminDeleteRoomBtn.onclick = async () => {
  if(mode !== "admin") return;
  if(!adminSelectedRoom) return alert("請先選擇左側房間");

  const room = adminSelectedRoom;
  const ok = confirm(`確定要刪除房間「${room}」的所有訊息？\n此動作不可復原。`);
  if(!ok) return;

  try{
    // 先停止監聽，避免刪除過程 UI 一直刷新
    if(adminUnsubRoom){ adminUnsubRoom(); adminUnsubRoom=null; }

    const count = await deleteRoomAllMessages(room);

    // 清空右側
    adminSelectedRoom = "";
    adminThread.innerHTML = "";
    adminRoomTitle.textContent = "尚未選擇房間";
    adminRoomSub.textContent = "點左側對話開始回覆";
    adminInput.disabled = true;
    adminInput.value = "";
    adminInput.placeholder = "請先選擇房間…";

    // 從列表移除（純前端）
    adminRoomsMap.delete(room);
    adminRenderRoomList();

    alert(`已刪除 ${count} 則訊息（房間：${room}）`);

  }catch(err){
    console.error(err);
    alert("刪除失敗：\n" + (err?.message || err));
    // 失敗就恢復監聽
    adminSubscribeRoom();
  }
};

adminForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(mode !== "admin") return;
  if(!adminSelectedRoom) return alert("請先選擇左側房間");

  const text = adminInput.value.trim();
  if(!text) return;

  try{
    await addDoc(collection(db,"messages"),{
      room: adminSelectedRoom,
      role: "admin",
      sender: "管理員",
      text,
      timestamp: Date.now()
    });
    adminInput.value = "";
  }catch(err){
    console.error(err);
    alert("管理員端：送出失敗\n" + (err?.message || err));
  }
});

/* =======================
   Start
======================= */
showRole();
</script>
</body>
</html>
